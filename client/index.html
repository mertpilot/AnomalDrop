<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AnomalDrop</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AnomalDrop">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>

    <link rel="icon" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="manifest" href="manifest.json">

    <style>
        /* --- ANOMAL PRO DESIGN SYSTEM (V8 - SECURE LOADER) --- */
        :root {
            --bg-body: #000000;
            --accent: #ff2d55;
            --accent-glow: #ff0044;
            --accent-dark: #520012;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.15);
            --ease-apple: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* --- RED LAVA ATMOSPHERE --- */
        .lava-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background: #000; overflow: hidden; pointer-events: none;
        }

        .lava-orb {
            position: absolute; border-radius: 50%; filter: blur(90px);
            opacity: 0.5; animation: floatLava 15s infinite ease-in-out alternate;
        }

        .orb-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: var(--accent); animation-duration: 20s; }
        .orb-2 { bottom: -10%; right: -10%; width: 70vw; height: 70vw; background: var(--accent-glow); opacity: 0.3; animation-duration: 25s; animation-direction: alternate-reverse; }
        .orb-3 { top: 40%; left: 30%; width: 50vw; height: 50vw; background: var(--accent-dark); opacity: 0.6; animation-duration: 30s; }

        @keyframes floatLava {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.05); }
            100% { transform: translate(-20px, 20px) scale(0.95); }
        }

        /* HEADER */
        header {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;
            z-index: 50; height: 70px;
        }

        .brand-mark {
            font-weight: 800; font-size: 16px; letter-spacing: -0.5px;
            color: #fff; text-shadow: 0 0 20px rgba(255, 45, 85, 0.6);
        }
        .brand-mark span { color: var(--accent); }

        .header-controls { display: flex; align-items: center; gap: 12px; }

        .icon-button {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s var(--ease-apple);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .icon-button:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }
        .icon { width: 20px; height: 20px; fill: #fff; }

        #send-all-btn { display: none; background: rgba(255, 45, 85, 0.2); border-color: rgba(255, 45, 85, 0.4); }
        #send-all-btn:hover { background: var(--accent); border-color: var(--accent); }
        #send-all-btn svg { fill: #fff; }

        /* RADAR AREA */
        x-peers {
            flex-grow: 1; width: 100%; height: 100%;
            display: flex; flex-direction: row; flex-wrap: wrap;     
            justify-content: center; align-content: center; align-items: center;
            gap: 24px; padding: 80px 20px 60px 20px; 
            z-index: 10; overflow-y: auto;
        }

        x-peer {
            width: 110px; height: 140px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            cursor: pointer; transition: transform 0.3s var(--ease-apple);
            position: relative;
        }
        x-peer:active { transform: scale(0.95); opacity: 0.8; }

        x-peer .device-icon {
            width: 80px; height: 80px; border-radius: 50%;
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transition: all 0.3s var(--ease-apple);
            position: relative; overflow: hidden;
        }

        x-peer .progress {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: linear-gradient(to top, var(--accent), var(--accent-glow));
            opacity: 0.8; transition: height 0.2s linear; z-index: 1;
            mix-blend-mode: overlay;
        }
        
        x-peer circle { display: none; } 
        x-peer svg.progress-ring { display: none; }

        x-peer:hover .device-icon {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(255, 45, 85, 0.5);
            transform: translateY(-5px);
        }

        x-peer .name {
            margin-top: 12px; font-size: 13px; font-weight: 600;
            color: var(--text-primary); text-align: center;
            width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 2;
        }
        x-peer .status { font-size: 11px; color: var(--text-secondary); margin-top: 2px; height: 14px; z-index: 2; }

        /* EMPTY STATE */
        x-no-peers {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            pointer-events: none; z-index: 20;
        }
        x-no-peers h2 { font-weight: 700; font-size: 22px; margin: 0 0 8px 0; color: #fff; }
        x-no-peers p { color: var(--text-secondary); font-size: 15px; }

        x-instructions {
            position: absolute; bottom: 40px; color: var(--text-secondary);
            font-size: 12px; font-weight: 500; opacity: 0.5; text-align: center; width: 100%; pointer-events: none;
        }

        /* DIALOGS */
        x-dialog {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; display: none;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        x-dialog[show] { display: flex; opacity: 1; }

        x-paper {
            background: #151515; width: 340px; border-radius: 28px; padding: 30px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center; transform: scale(0.95); transition: transform 0.3s;
            position: relative; overflow: hidden; /* Taşmayı önle */
        }
        x-dialog[show] x-paper { transform: scale(1); }

        h3 { margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: #fff; }
        .file-info { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; line-height: 1.4; position: relative; z-index: 2; }
        .file-highlight { color: #fff; font-weight: 600; }

        .btn-group { display: flex; gap: 12px; margin-top: 15px; position: relative; z-index: 2; }
        
        .button {
            flex: 1; padding: 14px 0; border-radius: 14px; font-size: 14px; font-weight: 600;
            border: none; cursor: pointer; transition: all 0.2s; color: #fff; text-decoration: none;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); }
        
        /* --- YENİ EKLENEN: NEON PROGRESS BAR & KİLİT SİSTEMİ --- */
        
        /* 1. Kilitli Buton Stili */
        .button.disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: none;
        }

        /* 2. Neon Yükleme Çubuğu */
        .transfer-progress-track {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 4px; /* İncelik */
            background: rgba(255, 255, 255, 0.1);
            z-index: 10;
        }

        .transfer-progress-fill {
            height: 100%;
            width: 0%; /* JS ile artacak */
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent), 0 0 30px var(--accent); /* Neon Parlama */
            transition: width 0.1s linear;
        }

        /* 3. Yükleme Metni */
        #transferStatus {
            font-size: 11px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            font-weight: 700;
            opacity: 0; /* Başta gizli */
            transition: opacity 0.3s;
        }
        
        /* ------------------------------------------------------- */

        /* GÜVENLİK KİLİDİ (Eski animasyon yerine artık JS kontrolü kullanacağız ama dursun) */
        @keyframes safety-unlock {
            0% { opacity: 0.5; pointer-events: none; cursor: wait; }
            100% { opacity: 1; pointer-events: auto; cursor: pointer; }
        }

        .input-field { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; color: #fff; font-size: 15px; outline: none; margin-bottom: 24px; }
        
        x-about {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            backdrop-filter: blur(30px); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .name-input { margin-top: 20px; background: transparent; border: none; border-bottom: 2px solid var(--accent); color: #fff; font-size: 20px; text-align: center; width: 80%; padding: 10px; outline: none; }
        
        .toast-container { position: fixed; bottom: 80px; width: 100%; display:flex; justify-content: center; pointer-events: none; z-index: 300; }
        x-toast {
            background: #fff; color: #000; padding: 12px 28px; border-radius: 30px;
            font-size: 14px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transform: translateY(20px); opacity: 0; transition: 0.4s;
        }
        x-toast[show] { transform: translateY(0); opacity: 1; }
        
        .close-about { margin-top: 40px; width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>

<body>
    <input type="file" id="batch-file-input" style="display: none;" multiple>

    <div class="lava-background">
        <div class="lava-orb orb-1"></div>
        <div class="lava-orb orb-2"></div>
        <div class="lava-orb orb-3"></div>
    </div>

    <header>
        <div class="brand-mark">Anomal<span>Drop</span></div>
        <div class="header-controls">
            <div id="send-all-btn" class="icon-button" onclick="openBatchPicker()" title="Toplu Gönder">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            </div>
            <div class="icon-button" onclick="toggleAbout(true)">
                <svg class="icon"><use xlink:href="#info-outline" /></svg>
            </div>
        </div>
    </header>
    
    <x-peers>
        </x-peers>
    
    <x-no-peers>
        <h2>Radar Aktif</h2>
        <p>Ağ taranıyor...</p>
    </x-no-peers>
    
    <x-instructions desktop="Dosya için tıkla • Mesaj için sağ tıkla" mobile="Dosya için dokun • Mesaj için basılı tut"></x-instructions>

    <x-dialog id="receiveDialog">
        <x-paper>
            <h3>Dosya Alınıyor...</h3> <div id="transferStatus">BAĞLANTI KURULUYOR...</div>

            <div class="file-info">
                <span id="fileName" class="file-highlight">Dosya</span><br>
                <span id="fileSize">Boyut</span>
            </div>
            
            <div class='preview' style="visibility: hidden; margin-bottom:20px; border-radius:12px; overflow:hidden; max-height:150px;">
                <img id='img-preview' src="" style="width:100%; object-fit: cover;">
            </div>

            <div class="transfer-progress-track">
                <div class="transfer-progress-fill" id="transferFill"></div>
            </div>

            <div class="btn-group">
                <button class="button btn-secondary" close>Reddet</button>
                <a class="button btn-primary disabled" id="download">Bekleyiniz...</a>
            </div>
        </x-paper>
    </x-dialog>

    <x-dialog id="sendTextDialog">
        <form action="#" style="width:100%">
            <x-paper>
                <h3>Mesaj Gönder</h3>
                <div id="textInput" class="input-field" role="textbox" placeholder="Mesajınızı yazın..." autocomplete="off" autofocus contenteditable></div>
                <div class="btn-group">
                    <a class="button btn-secondary" close>İptal</a>
                    <button class="button btn-primary" type="submit" close>Gönder</button>
                </div>
            </x-paper>
        </form>
    </x-dialog>

    <x-dialog id="receiveTextDialog">
        <x-paper>
            <h3>Mesaj</h3>
            <div id="text" class="input-field" style="background:transparent; border:none; padding:0; margin:10px 0 30px 0; text-align:center;"></div>
            <div class="btn-group">
                <button class="button btn-secondary" close>Kapat</button>
                <button class="button btn-primary" id="copy" close>Kopyala</button>
            </div>
        </x-paper>
    </x-dialog>

    <div class="toast-container">
        <x-toast id="toast">İşlem Tamamlandı</x-toast>
    </div>

    <x-about id="about">
        <div onclick="event.stopPropagation()">
            <h1 style="color: #fff;">Anomal<span style="color:var(--accent)">Drop</span></h1>
            <p style="margin-bottom: 20px; opacity: 0.7;">Hard Aesthetic File Transfer</p>
            <div style="margin-bottom: 20px;">
                <input type="text" id="displayName" class="name-input" placeholder="Görünen İsim" autocomplete="off" maxlength="20">
                <p style="font-size: 11px; opacity: 0.4; margin-top:8px;">Değişiklik için sayfayı yenile.</p>
            </div>
            <p style="font-size: 12px; opacity: 0.3;">Engineered by Anomal House</p>
            <div class="close-about" onclick="toggleAbout(false); saveName();">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="#fff"/></svg>
            </div>
        </div>
    </x-about>

    <svg style="display: none;">
        <symbol id=info-outline viewBox="0 0 24 24"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"></path></symbol>
        <symbol id=close viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></symbol>
        <symbol id=wifi-tethering viewBox="0 0 24 24"><path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"></path></symbol>
        <symbol id=desktop-mac viewBox="0 0 24 24"><path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path></symbol>
        <symbol id=phone-iphone viewBox="0 0 24 24"><path d="M15.5 1h-8C6.12 1 5 2.12 5 3.5v17C5 21.88 6.12 23 7.5 23h8c1.38 0 2.5-1.12 2.5-2.5v-17C18 2.12 16.88 1 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"></path></symbol>
        <symbol id=tablet-mac viewBox="0 0 24 24"><path d="M18.5 0h-14C3.12 0 2 1.12 2 2.5v19C2 22.88 3.12 24 4.5 24h14c1.38 0 2.5-1.12 2.5-2.5v-19C21 1.12 19.88 0 18.5 0zm-7 23c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm7.5-4H4V3h15v16z"></path></symbol>
    </svg>

    <script src="scripts/network.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/clipboard.js" async></script>
    
    <audio id="blop" autobuffer="true">
        <source src="sounds/blop.mp3" type="audio/mpeg">
        <source src="sounds/blop.ogg" type="audio/ogg">
    </audio>

    <script>
        // --- ANOMAL CORE (V7.0 FIX) ---

        const nameInput = document.getElementById('displayName');
        if(localStorage.getItem('anomal-name')) nameInput.value = localStorage.getItem('anomal-name');

        function saveName() {
            const val = nameInput.value.trim();
            if(val) {
                localStorage.setItem('anomal-name', val);
                localStorage.setItem('display-name', val); 
            }
        }

        function toggleAbout(show) {
            document.getElementById('about').style.display = show ? 'flex' : 'none';
        }

        // --- TOPLU GÖNDER ---
        function openBatchPicker() {
            // Düzeltme: window.anomalPeers kontrolü
            if(!window.anomalPeers || Object.keys(window.anomalPeers).length === 0) {
                showToast("Etrafta kimse yok.");
                return;
            }
            document.getElementById('batch-file-input').click();
        }

        document.getElementById('batch-file-input').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            // Düzeltme: Doğrudan network.js peer listesini kullan
            // (Bu kısım network.js güncellendiğinde tam çalışacak)
            const peers = window.anomalPeers ? Object.values(window.anomalPeers) : [];
            
            showToast(`${peers.length} cihaza dosya dağıtılıyor...`);

            // Dosya referansını al
            const file = files[0]; 

            peers.forEach((peer, index) => {
                setTimeout(() => {
                    // UI Efekti
                    const uiPeer = document.querySelector(`x-peer`); // İyileştirilebilir
                    if(uiPeer) {
                        uiPeer.style.transform = "scale(1.05)";
                        setTimeout(() => uiPeer.style.transform = "scale(1)", 200);
                    }

                    // KRİTİK: Doğrudan gönderme fonksiyonu
                    if(peer.send) {
                        peer.send(file);
                    }

                }, index * 1500); 
            });

            this.value = '';
        });

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.setAttribute('show', 'true');
            setTimeout(() => t.removeAttribute('show'), 3000);
        }

        const peerObserver = new MutationObserver(() => {
            const count = document.querySelectorAll('x-peer').length;
            const btn = document.getElementById('send-all-btn');
            const noPeers = document.querySelector('x-no-peers');
            if(count > 0) { btn.style.display = 'flex'; noPeers.style.display = 'none'; } 
            else { btn.style.display = 'none'; noPeers.style.display = 'flex'; }
        });
        peerObserver.observe(document.querySelector('x-peers'), {childList: true, subtree: true});

    </script>
</body>
</html>